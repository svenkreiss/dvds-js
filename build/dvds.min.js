/**
 * dvds.js - v0.0.1 - build 2014-02-28 19:02:22
 * Contributors: 
 * Copyright (c) 2014 Sven Kreiss; MIT license
 */
if("function"!=typeof define)var define=require("amdefine")(module);if(define("dvds",["crypto-js.SHA3"],function(a){return dvds={},dvds.CommitTree=function(){},dvds.Commit=function(b,c){function d(a,b){var c=[];for(i in b)c.push(a.indexOf(b[i]));for(i in c)0!=i&&c[i-1]>c[i]&&(c[i]=a.indexOf(b[i],i-1));return c}function e(a,b,c){var e=[],f=d(a,c),g=d(b,c);console.log(f),console.log(g);for(i in c)f[i]==g[i]&&f[i]>=0?e.push(c[i]):f[i]==i&&-1==g[i]?i<b.length&&e.push(b[i]):g[i]==i&&-1==f[i]?i<a.length&&e.push(a[i]):-1==f[i]&&-1==g[i]&&e.push(a[i]);return e}this.parents=b,this.data=JSON.parse(JSON.stringify(c)),this.dataHash=a.SHA3(JSON.stringify(c)).toString(),this.date=new Date;var f=[this.dataHash,this.date];this.parents&&b.map(function(a){f.push(a.id)}),this.id=a.SHA3(JSON.stringify(f)).toString().substr(0,40),this.parentIds=function(){return this.parents?this.parents.map(function(a){return a.id}):["0"]},this.idsRecursive=function(){var a=[this.id];return this.parents&&this.parents.map(function(b){a=a.concat(b.idsRecursive())}),a},this.searchId=function(a){if(a.indexOf(this.id)>=0)return this;if(!this.parents)return null;for(p in b){var c=b[p].searchId(a);if(c)return c}return null},this.clone=function(){var a=new dvds.Commit(this.parents,this.data);return a.date=this.date,a.id=this.id,a},this.recursiveThreeWayMerge=function(a){var b=a.idsRecursive(),c=this.idsRecursive();console.log(c),console.log(b);var d=a.searchId(c),f=this.searchId(b),g=f?f:d;if(f&&d){console.log("Found ancestors in both branches."),f.id!=d.id?(console.log("crap. need to create a virtual common ancestor before merge."),g=f.recursiveThreeWayMerge(d)):console.log("great. common ancestor found.");var h=this.data;Array.isArray(this.data)&&(console.log("merging arrays"),h=e(this.data,a.data,g.data),console.log(h));var i=new dvds.Commit([this,a],h);return console.log("mergedCommit"),console.log(i.parentIds().join(",")),i}return console.log("ERROR: Did not find ancestors in both branches."),console.log("Abort merge."),console.log(d),void console.log(f)}},dvds.Commit.parseJSON=function(a){var b=null;a.parents&&(b=a.parents.map(function(a){return a.id}));var c=new dvds.Commit(b,a.data);return c.dataHash=a.dataHash,c.date=a.date,c.id=a.id,c},dvds.Repository=function(a){this.data=a,this.commits=[],this.currentCommit=null,this.commitById=function(a){for(c in this.commits)if(this.commits[c].id==a)return this.commits[c]},this.commitConnectionsToString=function(){var a=[];for(c in this.commits){var b=this.commits[c].parentIds().map(function(a){return a.substr(0,7)}).join(",");a.push(b+" <-- "+this.commits[c].id.substr(0,7))}return a.join(" ... ")},this.commit=function(){var a=this.currentCommit?[this.currentCommit]:null;return commit=new dvds.Commit(a,this.data),this.currentCommit&&commit.dataHash==this.currentCommit.dataHash?void console.log("No change. Skipping."):(this.commits.push(commit),void(this.currentCommit=commit))},this.toString=function(){return this.currentCommit?this.data+" -- committed: "+this.currentCommit.id+": "+this.currentCommit.data.toString():this.data+" -- no commits"},this.fork=function(){this.commit();var a=new dvds.Repository(JSON.parse(JSON.stringify(this.data)));return a.commits=this.commits.map(function(a){return a.clone()}),a.currentCommit=a.commits[a.commits.length-1],a},this.merge=function(a){this.commit(),a.commit();var b=this.currentCommit.recursiveThreeWayMerge(a.currentCommit);this.currentCommit=b,this.commits.push(b),this.data=b.data;var d=this.commits.map(function(a){return a.id});for(c in a.commits)d.indexOf(a.commits[c].id)<0&&this.commits.push(a.commits[c]);return console.log("merge done"),console.log(this.commitConnectionsToString()),b}},dvds.Repository.parseJSON=function(a){var b=new dvds.Repository(a.data);a.commits.map(function(a){b.commits.push(dvds.Commit.parseJSON(a))}),a.currentCommit&&(b.currentCommit=b.commitById(a.currentCommit.id));for(c in b.commits){var d=b.commits[c].parents;d&&d.map(function(a){return b.commitById(a)})}return b},dvds}),"function"!=typeof define)var define=require("amdefine")(module);define("dvds.visualize",["dvds"],function(a){return a.visualize={},a.visualize.CommitGraph=function(a){function b(){e.attr("transform",function(a){return"translate("+a.x+","+a.y+")"}),f.attr("x1",function(a){return a.source.x}).attr("y1",function(a){return a.source.y}).attr("x2",function(a){return a.target.x}).attr("y2",function(a){return a.target.y})}var c=a.attr("width"),d=a.attr("height");c||(c=600),d||(d=400);var e,f,g=d3.layout.force().size([c,d]).linkDistance(50).charge(-400).on("tick",b),h=function(a,b){h=g.nodes();var e=a.currentCommit.id;return b.map(function(a){h.push(a[0]==e?{id:a[0],x:9*c/10,y:d/2,fixed:!0}:{id:a[0],x:c/2,y:d/10})}),h.push({id:"0",x:c/10,y:d/2,fixed:!0}),h},i=function(a,b,c){function d(a){for(n in c)if(c[n].id==a)return c[n]}return i=g.links(),b.map(function(a){a[1].map(function(b){i.push({source:d(a[0]),target:d(b)})})}),i};return function(b){var c=b.commits.map(function(a){return[a.id,a.parentIds()]});h=h(b,c),i=i(b,c,h),console.log(h),console.log(i),e=a.selectAll(".node"),f=a.selectAll(".link"),e=e.data(h);var d=e.enter().append("g").attr("class","node").call(g.drag);d.append("circle").attr("r",5),d.append("text").attr("x",0).attr("y",20).text(function(a){return a&&a.id?a.id.substr(0,7):"undefined"}),f=f.data(i),f.enter().append("line").attr("class","link"),console.log("starting"),g.start()}},a.visualize});